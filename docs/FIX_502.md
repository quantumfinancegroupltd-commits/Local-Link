# Fix 502 on locallink.agency

A **502 Bad Gateway** means the gateway (nginx) could not get a valid response from the API. Do these on the **server** (SSH in first).

---

## 1. Check API is running and see why it might be failing

```bash
cd ~/LocalLink
docker compose -f docker-compose.selfhost.yml ps
docker compose -f docker-compose.selfhost.yml logs api --tail 80
```

- If **api** is exited or restarting, the logs usually show the cause (e.g. missing env, DB connection error).
- If the API **crashes on startup**, it’s often one of:
  - **JWT_SECRET** or **ADMIN_BOOTSTRAP_SECRET** missing or still set to a placeholder (e.g. `dev_secret_change_me`).
  - **DATABASE_URL** wrong (e.g. Supabase with wrong password or missing `?sslmode=require`).

---

## 2. Fix `.env` on the server

```bash
cd ~/LocalLink && nano .env
```

Ensure you have (no quotes needed, one per line):

- **JWT_SECRET** = a long random string (e.g. from `openssl rand -hex 32`).
- **ADMIN_BOOTSTRAP_SECRET** = another long random string.
- **DATABASE_URL** = either:
  - **Local DB (simplest):** leave it unset or comment it out so the compose default is used (`postgresql://locallink:locallink@db:5432/locallink`), or
  - **Supabase:** full URI with your real password and `?sslmode=require` at the end.

Save (Ctrl+O, Enter) and exit (Ctrl+X).

---

## 3. Restart API and gateway

```bash
cd ~/LocalLink
docker compose -f docker-compose.selfhost.yml up -d --force-recreate api worker gateway
```

Wait ~30 seconds (API has a healthcheck and gateway waits for it). Then check:

```bash
docker compose -f docker-compose.selfhost.yml ps
curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/api/health
```

You want **200** from the curl. If you get 502, check API logs again (step 1).

---

## 4. If you use Supabase

- Run migrations **from your Mac** (see [SUPABASE_SETUP.md](SUPABASE_SETUP.md)) so the Supabase DB has the right tables.
- On the server, **DATABASE_URL** must be exactly that Supabase URI (with password and `?sslmode=require`).
- The API container already uses `NODE_OPTIONS=--dns-result-order=ipv4first` to avoid IPv6 connection issues.

---

**Summary:** 502 = gateway can’t reach a healthy API. Fix `.env` (secrets + DATABASE_URL), then `docker compose … up -d --force-recreate api worker gateway` and confirm `/api/health` returns 200.
