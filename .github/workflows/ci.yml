name: CI

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install (backend)
        working-directory: backend
        run: npm ci

      - name: Test (backend)
        working-directory: backend
        run: npm test

  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install (frontend)
        working-directory: frontend
        run: npm ci

      - name: Build (frontend)
        working-directory: frontend
        run: npm run build

  smoke:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: locallink
          POSTGRES_PASSWORD: locallink
          POSTGRES_DB: locallink
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U locallink -d locallink"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      DATABASE_URL: postgresql://locallink:locallink@localhost:5432/locallink
      ADMIN_BOOTSTRAP_SECRET: ci_secret_do_not_use_in_prod
      JWT_SECRET: ci_jwt_secret_min_32_chars_long
      NODE_ENV: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install (backend)
        working-directory: backend
        run: npm ci

      - name: Migrate
        working-directory: backend
        run: npm run migrate

      - name: Start API
        working-directory: backend
        run: |
          node src/server.js &
          echo $! > api.pid
          for i in $(seq 1 30); do
            curl -sf http://localhost:4000/api/health && break
            sleep 2
          done
          curl -sf http://localhost:4000/api/health || (echo "API failed to start"; exit 1)

      - name: Bootstrap admin and get token
        id: admin
        run: |
          resp=$(curl -sS -X POST http://localhost:4000/api/bootstrap/admin \
            -H 'Content-Type: application/json' \
            -d '{"secret":"ci_secret_do_not_use_in_prod","name":"CI Admin","email":"ci-admin@locallink.test","password":"CiAdminPass123!"}')
          if echo "$resp" | grep -q '"token"'; then
            token=$(echo "$resp" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))")
          else
            login=$(curl -sS -X POST http://localhost:4000/api/login -H 'Content-Type: application/json' -d '{"email":"ci-admin@locallink.test","password":"CiAdminPass123!"}')
            token=$(echo "$login" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))")
          fi
          echo "token=$token" >> $GITHUB_OUTPUT

      - name: Run full smoke test
        run: |
          BASE_URL=http://localhost:4000 SMOKE_FULL=1 SMOKE_ADMIN_TOKEN="${{ steps.admin.outputs.token }}" ./scripts/smoke-test.sh

      - name: Stop API
        if: always()
        working-directory: backend
        run: '[ -f api.pid ] && kill $(cat api.pid) 2>/dev/null || true'


